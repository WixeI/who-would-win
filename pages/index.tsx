/* eslint-disable @next/next/no-img-element */
import { inferProcedureOutput } from '@trpc/server';
import type { NextPage } from 'next';
import Head from 'next/head';
import Link from 'next/link';
import { useState } from 'react';
import { AppRouter } from '../server/routers/_app';
import { trpc } from '../utils/trpc';

const Home: NextPage = () => {
  const ctx = trpc.useContext();
  const { data, refetch } = trpc.getCharacters.useQuery();
  const castVoteMutation = trpc.castVote.useMutation();
  const [results, setResults] = useState<inferProcedureOutput<AppRouter['getResults']> | null>(
    null
  );
  const [canVote, setCanVote] = useState(true);

  if (!data) {
    return <div>Loading...</div>;
  }

  async function castVote(selected: 'first' | 'second') {
    if (!data || !data.char1 || !data.char2) return { success: false };

    if (selected === 'first')
      castVoteMutation.mutate(
        { victoriousId: data.char1.id, loserId: data.char2.id },
        {
          onSuccess: async () => {
            if (!data || !data.char1 || !data.char2) return;
            const results = await ctx.getResults.fetch({
              char1Id: data.char1.id,
              char2Id: data.char2.id
            });
            setResults(results);
            setCanVote(false);
          }
        }
      );
    else if (selected === 'second') {
      castVoteMutation.mutate(
        { victoriousId: data.char2.id, loserId: data.char1.id },
        {
          onSuccess: async () => {
            if (!data || !data.char1 || !data.char2) return;
            const results = await ctx.getResults.fetch({
              char1Id: data.char1.id,
              char2Id: data.char2.id
            });
            setResults(results);
            setCanVote(false);
          }
        }
      );
    }
  }

  function handleSkipFight() {
    setResults(null);
    setCanVote(true);
    refetch();
  }

  return (
    <div className="flex h-screen w-screen flex-col">
      <Head>
        <title>Who Would Win</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <header className="flex bg-neutral-700 px-2 py-3 shadow-sm shadow-neutral-900">
        <span>Logo</span>
      </header>

      <main className="flex h-full flex-col gap-6 p-6 md:gap-10">
        <h1 className="text-center font-blackOpsOne text-4xl sm:text-5xl md:text-6xl">
          Who Would Win in a Fight?
        </h1>
        {/* Contestants Section */}
        <section className="flex items-stretch justify-center gap-2 sm:gap-8">
          {/* Option 1 */}
          <div className="flex  flex-col items-center">
            <button
              onClick={() => canVote && castVote('first')}
              disabled={!canVote}
              className="flex h-full w-full max-w-[300px] flex-col gap-4 rounded-md bg-neutral-700 p-4 shadow-sm shadow-neutral-900 sm:gap-8 sm:pb-8 md:aspect-square">
              <img
                src="https://static.boredpanda.com/blog/wp-content/uploads/2017/12/funny-weird-wtf-stock-photos-19-5a3926af95d9d__700.jpg"
                alt="option-1"
              />
              <h2 className="md:text-xl">{data.char1?.name}</h2>
            </button>
            {/* Percentage */}
            {results && <p>{results.percentages.char1.toFixed(1)}%</p>}
          </div>

          <span className="self-center">vs</span>

          {/* Option 2 */}
          <div className="flex  flex-col items-center">
            <button
              onClick={() => canVote && castVote('second')}
              disabled={!canVote}
              className="flex h-full w-full max-w-[300px] flex-col gap-4 rounded-md bg-neutral-700 p-4 shadow-sm shadow-neutral-900 sm:gap-8 sm:pb-8 md:aspect-square">
              <img
                src="https://static.boredpanda.com/blog/wp-content/uploads/2017/12/funny-weird-wtf-stock-photos-19-5a3926af95d9d__700.jpg"
                alt="option-1"
              />
              <h2 className="md:text-xl">{data.char2?.name}</h2>
            </button>
            {/* Percentage */}
            {results && <p>{results.percentages.char2.toFixed(1)}%</p>}
          </div>
        </section>

        <section className="flex flex-col items-center gap-4">
          {/* Next Button */}
          <button onClick={handleSkipFight}>Next Fight</button>
          {/* Change Page */}
          <Link href="/Ranking">Ranking</Link>
          <Link href="/Add">Add New Fighter</Link>
        </section>
      </main>

      <footer className="flex flex-col items-center gap-2 px-4 py-8">
        {/* Textos */}
        <p>
          Created by <a href="https://github.com/WixeI">Paulo Portela Martins</a>
        </p>
      </footer>
    </div>
  );
};

export default Home;

{
  /*         <form onSubmit={onSubmitCreateCharacter}>
          <input name="text" type="text" className="text-black" />
          <button type="submit" className="rounded-md bg-emerald-400 p-2">
            Adicionar
          </button>
        </form> */
}
